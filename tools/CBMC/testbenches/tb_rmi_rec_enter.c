/*
 * (C) COPYRIGHT 2021 Arm Limited or its affiliates
 * ALL RIGHTS RESERVED
 *
 * This file was AUTOGENERATED from the RMM specification.
 * RMM specification source version: 404016e5-dirty
 */

#include "tb.h"
#include "tb_rmi_rec_enter.h"

bool tb_rmi_rec_enter(
    uint64_t rec,
    uint64_t run_ptr)
{
    // Initialize registers
    struct tb_regs __tb_regs = __tb_arb_regs();
    __tb_regs.X0 = SMC_RMM_REC_ENTER;
    __tb_regs.X1 = (uint64_t)rec;
    __tb_regs.X2 = (uint64_t)run_ptr;

    // Initialize global state
    __init_global_state(__tb_regs.X0);

    // Declare context variables
    struct rmi_rec_run_buffer run;

    // Assign context variables before command execution
    run = RecRun(run_ptr);

    // Pre-conditions
    bool failure_run_align_pre = !AddrIsGranuleAligned(run_ptr);
    bool failure_run_bound_pre = !PaIsDelegable(run_ptr);
    bool failure_run_pas_pre = Granule(run_ptr).pas != NS;
    bool failure_rec_align_pre = !AddrIsGranuleAligned(rec);
    bool failure_rec_bound_pre = !PaIsDelegable(rec);
    bool failure_rec_gran_state_pre = Granule(rec).state != REC;
    bool failure_realm_new_pre = Realm(Rec(rec).owner).state == NEW;
    bool failure_system_off_pre = Realm(Rec(rec).owner).state == SYSTEM_OFF;
    bool failure_rec_state_pre = Rec(rec).state == RUNNING;
    bool failure_rec_runnable_pre = Rec(rec).flags.runnable == NOT_RUNNABLE;
    bool failure_rec_mmio_pre = (run.entry.flags.emul_mmio == RMI_EMULATED_MMIO && Rec(rec).emulatable_abort != EMULATABLE_ABORT);
    bool failure_rec_gicv3_pre = !Gicv3ConfigIsValid(run.entry.gicv3_hcr, run.entry.gicv3_lrs);
    bool failure_rec_psci_pre = Rec(rec).psci_pending == PSCI_REQUEST_PENDING;
    bool no_failures_pre = !failure_run_align_pre
        && !failure_run_bound_pre
        && !failure_run_pas_pre
        && !failure_rec_align_pre
        && !failure_rec_bound_pre
        && !failure_rec_gran_state_pre
        && !failure_realm_new_pre
        && !failure_system_off_pre
        && !failure_rec_state_pre
        && !failure_rec_runnable_pre
        && !failure_rec_mmio_pre
        && !failure_rec_gicv3_pre
        && !failure_rec_psci_pre;
    bool success_rec_exit_pre = __tb_arb_bool();
    bool success_rec_emul_abt_pre = __tb_arb_bool();

    // Execute command and read the result.
    tb_handle_smc(&__tb_regs);
    uint64_t result =  __tb_regs.X0;

    // Assign context variables after command execution
    run = RecRun(run_ptr);

    // Post-conditions
    bool failure_run_align_post = ResultEqual_2(result, RMI_ERROR_INPUT);
    bool failure_run_bound_post = ResultEqual_2(result, RMI_ERROR_INPUT);
    bool failure_run_pas_post = ResultEqual_2(result, RMI_ERROR_INPUT);
    bool failure_rec_align_post = ResultEqual_2(result, RMI_ERROR_INPUT);
    bool failure_rec_bound_post = ResultEqual_2(result, RMI_ERROR_INPUT);
    bool failure_rec_gran_state_post = ResultEqual_2(result, RMI_ERROR_INPUT);
    bool failure_realm_new_post = ResultEqual_3(result, RMI_ERROR_REALM, 0);
    bool failure_system_off_post = ResultEqual_3(result, RMI_ERROR_REALM, 1);
    bool failure_rec_state_post = ResultEqual_2(result, RMI_ERROR_REC);
    bool failure_rec_runnable_post = ResultEqual_2(result, RMI_ERROR_REC);
    bool failure_rec_mmio_post = ResultEqual_2(result, RMI_ERROR_REC);
    bool failure_rec_gicv3_post = ResultEqual_2(result, RMI_ERROR_REC);
    bool failure_rec_psci_post = ResultEqual_2(result, RMI_ERROR_REC);
    bool success_rec_exit_post = success_rec_exit_pre;
    bool success_rec_emul_abt_post = success_rec_emul_abt_pre;

    // Failure condition assertions
    bool prop_failure_run_align_ante = failure_run_align_pre;
    __COVER(prop_failure_run_align_ante);
    if (prop_failure_run_align_ante) {
        bool prop_failure_run_align_cons = failure_run_align_post;
        __COVER(prop_failure_run_align_cons);
        __ASSERT(prop_failure_run_align_cons, "prop_failure_run_align_cons");
    }

    bool prop_failure_run_bound_ante = !failure_run_align_pre
        && failure_run_bound_pre;
    __COVER(prop_failure_run_bound_ante);
    if (prop_failure_run_bound_ante) {
        bool prop_failure_run_bound_cons = failure_run_bound_post;
        __COVER(prop_failure_run_bound_cons);
        __ASSERT(prop_failure_run_bound_cons, "prop_failure_run_bound_cons");
    }

    bool prop_failure_run_pas_ante = !failure_run_align_pre
        && !failure_run_bound_pre
        && failure_run_pas_pre;
    __COVER(prop_failure_run_pas_ante);
    if (prop_failure_run_pas_ante) {
        bool prop_failure_run_pas_cons = failure_run_pas_post;
        __COVER(prop_failure_run_pas_cons);
        __ASSERT(prop_failure_run_pas_cons, "prop_failure_run_pas_cons");
    }

    bool prop_failure_rec_align_ante = !failure_run_align_pre
        && !failure_run_bound_pre
        && !failure_run_pas_pre
        && failure_rec_align_pre;
    __COVER(prop_failure_rec_align_ante);
    if (prop_failure_rec_align_ante) {
        bool prop_failure_rec_align_cons = failure_rec_align_post;
        __COVER(prop_failure_rec_align_cons);
        __ASSERT(prop_failure_rec_align_cons, "prop_failure_rec_align_cons");
    }

    bool prop_failure_rec_bound_ante = !failure_run_align_pre
        && !failure_run_bound_pre
        && !failure_run_pas_pre
        && !failure_rec_align_pre
        && failure_rec_bound_pre;
    __COVER(prop_failure_rec_bound_ante);
    if (prop_failure_rec_bound_ante) {
        bool prop_failure_rec_bound_cons = failure_rec_bound_post;
        __COVER(prop_failure_rec_bound_cons);
        __ASSERT(prop_failure_rec_bound_cons, "prop_failure_rec_bound_cons");
    }

    bool prop_failure_rec_gran_state_ante = !failure_run_align_pre
        && !failure_run_bound_pre
        && !failure_run_pas_pre
        && !failure_rec_align_pre
        && !failure_rec_bound_pre
        && failure_rec_gran_state_pre;
    __COVER(prop_failure_rec_gran_state_ante);
    if (prop_failure_rec_gran_state_ante) {
        bool prop_failure_rec_gran_state_cons = failure_rec_gran_state_post;
        __COVER(prop_failure_rec_gran_state_cons);
        __ASSERT(prop_failure_rec_gran_state_cons, "prop_failure_rec_gran_state_cons");
    }

    bool prop_failure_realm_new_ante = !failure_run_align_pre
        && !failure_run_bound_pre
        && !failure_run_pas_pre
        && !failure_rec_align_pre
        && !failure_rec_bound_pre
        && !failure_rec_gran_state_pre
        && failure_realm_new_pre;
    __COVER(prop_failure_realm_new_ante);
    if (prop_failure_realm_new_ante) {
        bool prop_failure_realm_new_cons = failure_realm_new_post;
        __COVER(prop_failure_realm_new_cons);
        __ASSERT(prop_failure_realm_new_cons, "prop_failure_realm_new_cons");
    }

    bool prop_failure_system_off_ante = !failure_run_align_pre
        && !failure_run_bound_pre
        && !failure_run_pas_pre
        && !failure_rec_align_pre
        && !failure_rec_bound_pre
        && !failure_rec_gran_state_pre
        && !failure_realm_new_pre
        && failure_system_off_pre;
    __COVER(prop_failure_system_off_ante);
    if (prop_failure_system_off_ante) {
        bool prop_failure_system_off_cons = failure_system_off_post;
        __COVER(prop_failure_system_off_cons);
        __ASSERT(prop_failure_system_off_cons, "prop_failure_system_off_cons");
    }

    bool prop_failure_rec_state_ante = !failure_run_align_pre
        && !failure_run_bound_pre
        && !failure_run_pas_pre
        && !failure_rec_align_pre
        && !failure_rec_bound_pre
        && !failure_rec_gran_state_pre
        && !failure_realm_new_pre
        && !failure_system_off_pre
        && failure_rec_state_pre;
    __COVER(prop_failure_rec_state_ante);
    if (prop_failure_rec_state_ante) {
        bool prop_failure_rec_state_cons = failure_rec_state_post;
        __COVER(prop_failure_rec_state_cons);
        __ASSERT(prop_failure_rec_state_cons, "prop_failure_rec_state_cons");
    }

    bool prop_failure_rec_runnable_ante = !failure_run_align_pre
        && !failure_run_bound_pre
        && !failure_run_pas_pre
        && !failure_rec_align_pre
        && !failure_rec_bound_pre
        && !failure_rec_gran_state_pre
        && !failure_realm_new_pre
        && !failure_system_off_pre
        && !failure_rec_state_pre
        && failure_rec_runnable_pre;
    __COVER(prop_failure_rec_runnable_ante);
    if (prop_failure_rec_runnable_ante) {
        bool prop_failure_rec_runnable_cons = failure_rec_runnable_post;
        __COVER(prop_failure_rec_runnable_cons);
        __ASSERT(prop_failure_rec_runnable_cons, "prop_failure_rec_runnable_cons");
    }

    bool prop_failure_rec_mmio_ante = !failure_run_align_pre
        && !failure_run_bound_pre
        && !failure_run_pas_pre
        && !failure_rec_align_pre
        && !failure_rec_bound_pre
        && !failure_rec_gran_state_pre
        && !failure_realm_new_pre
        && !failure_system_off_pre
        && !failure_rec_state_pre
        && !failure_rec_runnable_pre
        && failure_rec_mmio_pre;
    __COVER(prop_failure_rec_mmio_ante);
    if (prop_failure_rec_mmio_ante) {
        bool prop_failure_rec_mmio_cons = failure_rec_mmio_post;
        __COVER(prop_failure_rec_mmio_cons);
        __ASSERT(prop_failure_rec_mmio_cons, "prop_failure_rec_mmio_cons");
    }

    bool prop_failure_rec_gicv3_ante = !failure_run_align_pre
        && !failure_run_bound_pre
        && !failure_run_pas_pre
        && !failure_rec_align_pre
        && !failure_rec_bound_pre
        && !failure_rec_gran_state_pre
        && !failure_realm_new_pre
        && !failure_system_off_pre
        && !failure_rec_state_pre
        && !failure_rec_runnable_pre
        && !failure_rec_mmio_pre
        && failure_rec_gicv3_pre;
    __COVER(prop_failure_rec_gicv3_ante);
    if (prop_failure_rec_gicv3_ante) {
        bool prop_failure_rec_gicv3_cons = failure_rec_gicv3_post;
        __COVER(prop_failure_rec_gicv3_cons);
        __ASSERT(prop_failure_rec_gicv3_cons, "prop_failure_rec_gicv3_cons");
    }

    bool prop_failure_rec_psci_ante = !failure_run_align_pre
        && !failure_run_bound_pre
        && !failure_run_pas_pre
        && !failure_rec_align_pre
        && !failure_rec_bound_pre
        && !failure_rec_gran_state_pre
        && !failure_realm_new_pre
        && !failure_system_off_pre
        && !failure_rec_state_pre
        && !failure_rec_runnable_pre
        && !failure_rec_mmio_pre
        && !failure_rec_gicv3_pre
        && failure_rec_psci_pre;
    __COVER(prop_failure_rec_psci_ante);
    if (prop_failure_rec_psci_ante) {
        bool prop_failure_rec_psci_cons = failure_rec_psci_post;
        __COVER(prop_failure_rec_psci_cons);
        __ASSERT(prop_failure_rec_psci_cons, "prop_failure_rec_psci_cons");
    }

    // Success condition assertions
    bool prop_success_rec_exit_ante = no_failures_pre;
    __COVER(prop_success_rec_exit_ante);
    if (prop_success_rec_exit_ante) {
        bool prop_success_rec_exit_cons = success_rec_exit_post && (result == RMI_SUCCESS);
        __COVER(prop_success_rec_exit_cons);
        __ASSERT(prop_success_rec_exit_cons, "prop_success_rec_exit_cons");
    }

    bool prop_success_rec_emul_abt_ante = no_failures_pre;
    __COVER(prop_success_rec_emul_abt_ante);
    if (prop_success_rec_emul_abt_ante) {
        bool prop_success_rec_emul_abt_cons = success_rec_emul_abt_post && (result == RMI_SUCCESS);
        __COVER(prop_success_rec_emul_abt_cons);
        __ASSERT(prop_success_rec_emul_abt_cons, "prop_success_rec_emul_abt_cons");
    }

    // Assertion used to check consistency of the testbench
    __tb_expect_fail();

    return no_failures_pre;
}

