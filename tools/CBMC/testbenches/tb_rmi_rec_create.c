/*
 * (C) COPYRIGHT 2021 Arm Limited or its affiliates
 * ALL RIGHTS RESERVED
 *
 * This file was AUTOGENERATED from the RMM specification.
 * RMM specification source version: 9f097087-dirty
 */

#include "tb.h"
#include "tb_rmi_rec_create.h"

bool tb_rmi_rec_create(
    uint64_t rd,
    uint64_t rec,
    uint64_t params_ptr)
{
    // Initialize registers
    struct tb_regs __tb_regs = __tb_arb_regs();
    __tb_regs.X0 = SMC_RMM_REC_CREATE;
    __tb_regs.X1 = (uint64_t)rd;
    __tb_regs.X2 = (uint64_t)rec;
    __tb_regs.X3 = (uint64_t)params_ptr;

    // Initialize global state
    __init_global_state(__tb_regs.X0);

    // Declare context variables
    struct rmm_realm realm;
    struct rmi_rec_params_buffer params;
    uint64_t rec_index;

    // Assign context variables before command execution
    realm = Realm(rd);
    params = RecParams(params_ptr);
    rec_index = Realm(rd).rec_index;

    // Pre-conditions
    bool failure_params_align_pre = !AddrIsGranuleAligned(params_ptr);
    bool failure_params_bound_pre = !PaIsDelegable(params_ptr);
    bool failure_params_pas_pre = Granule(params_ptr).pas != NS;
    bool failure_rec_align_pre = !AddrIsGranuleAligned(rec);
    bool failure_rec_bound_pre = !PaIsDelegable(rec);
    bool failure_rec_state_pre = Granule(rec).state != DELEGATED;
    bool failure_rd_align_pre = !AddrIsGranuleAligned(rd);
    bool failure_rd_bound_pre = !PaIsDelegable(rd);
    bool failure_rd_state_pre = Granule(rd).state != RD;
    bool failure_realm_state_pre = realm.state != NEW;
    bool failure_mpidr_index_pre = RecIndex(params.mpidr) != realm.rec_index;
    bool failure_num_aux_pre = params.num_aux != RecAuxCount(rd);
    bool failure_aux_align_pre = !RecAuxAligned(params.aux, params.num_aux);
    bool failure_aux_alias_pre = RecAuxAlias(rec, params.aux, params.num_aux);
    bool failure_aux_state_pre = !RecAuxStateEqual(params.aux, params.num_aux, DELEGATED);
    bool no_failures_pre = !failure_params_align_pre
        && !failure_params_bound_pre
        && !failure_params_pas_pre
        && !failure_rec_align_pre
        && !failure_rec_bound_pre
        && !failure_rec_state_pre
        && !failure_rd_align_pre
        && !failure_rd_bound_pre
        && !failure_rd_state_pre
        && !failure_realm_state_pre
        && !failure_mpidr_index_pre
        && !failure_num_aux_pre
        && !failure_aux_align_pre
        && !failure_aux_alias_pre
        && !failure_aux_state_pre;
    bool success_runnable_pre = params.flags.runnable == RMI_RUNNABLE;
    bool success_not_runnable_pre = params.flags.runnable == RMI_NOT_RUNNABLE;

    // Execute command and read the result.
    tb_handle_smc(&__tb_regs);
    uint64_t result =  __tb_regs.X0;

    // Assign context variables after command execution
    params = RecParams(params_ptr);

    // Post-conditions
    bool failure_params_align_post = ResultEqual_2(result, RMI_ERROR_INPUT);
    bool failure_params_bound_post = ResultEqual_2(result, RMI_ERROR_INPUT);
    bool failure_params_pas_post = ResultEqual_2(result, RMI_ERROR_INPUT);
    bool failure_rec_align_post = ResultEqual_2(result, RMI_ERROR_INPUT);
    bool failure_rec_bound_post = ResultEqual_2(result, RMI_ERROR_INPUT);
    bool failure_rec_state_post = ResultEqual_2(result, RMI_ERROR_INPUT);
    bool failure_rd_align_post = ResultEqual_2(result, RMI_ERROR_INPUT);
    bool failure_rd_bound_post = ResultEqual_2(result, RMI_ERROR_INPUT);
    bool failure_rd_state_post = ResultEqual_2(result, RMI_ERROR_INPUT);
    bool failure_realm_state_post = ResultEqual_2(result, RMI_ERROR_REALM);
    bool failure_mpidr_index_post = ResultEqual_2(result, RMI_ERROR_INPUT);
    bool failure_num_aux_post = ResultEqual_2(result, RMI_ERROR_INPUT);
    bool failure_aux_align_post = ResultEqual_2(result, RMI_ERROR_INPUT);
    bool failure_aux_alias_post = ResultEqual_2(result, RMI_ERROR_INPUT);
    bool failure_aux_state_post = ResultEqual_2(result, RMI_ERROR_INPUT);
    bool success_rec_index_post = Realm(rd).rec_index == rec_index + 1;
    bool success_rec_gran_state_post = Granule(rec).state == REC;
    bool success_rec_owner_post = Rec(rec).owner == rd;
    bool success_rec_attest_post = Rec(rec).attest_state == NO_ATTEST_IN_PROGRESS;
    bool success_rec_mpidr_post = MpidrEqual(Rec(rec).mpidr, params.mpidr);
    bool success_rec_state_post = Rec(rec).state == READY;
    bool success_runnable_post = Rec(rec).flags.runnable == RUNNABLE;
    bool success_not_runnable_post = Rec(rec).flags.runnable == NOT_RUNNABLE;
    bool success_rec_gprs_post = (Rec(rec).gprs[0] == params.gprs[0] && Rec(rec).gprs[1] == params.gprs[1] && Rec(rec).gprs[2] == params.gprs[2] && Rec(rec).gprs[3] == params.gprs[3] && Rec(rec).gprs[4] == params.gprs[4] && Rec(rec).gprs[5] == params.gprs[5] && Rec(rec).gprs[6] == params.gprs[6] && Rec(rec).gprs[7] == params.gprs[7] && Rec(rec).gprs[8] == Zeros() && Rec(rec).gprs[9] == Zeros() && Rec(rec).gprs[10] == Zeros() && Rec(rec).gprs[11] == Zeros() && Rec(rec).gprs[12] == Zeros() && Rec(rec).gprs[13] == Zeros() && Rec(rec).gprs[14] == Zeros() && Rec(rec).gprs[15] == Zeros() && Rec(rec).gprs[16] == Zeros() && Rec(rec).gprs[17] == Zeros() && Rec(rec).gprs[18] == Zeros() && Rec(rec).gprs[19] == Zeros() && Rec(rec).gprs[20] == Zeros() && Rec(rec).gprs[21] == Zeros() && Rec(rec).gprs[22] == Zeros() && Rec(rec).gprs[23] == Zeros() && Rec(rec).gprs[24] == Zeros() && Rec(rec).gprs[25] == Zeros() && Rec(rec).gprs[26] == Zeros() && Rec(rec).gprs[27] == Zeros() && Rec(rec).gprs[28] == Zeros() && Rec(rec).gprs[29] == Zeros() && Rec(rec).gprs[30] == Zeros() && Rec(rec).gprs[31] == Zeros());
    bool success_rec_pc_post = Rec(rec).pc == params.pc;
    bool success_rim_post = Realm(rd).measurements[0] == RimExtendRec(realm, params);
    bool success_rec_aux_post = RecAuxEqual(Rec(rec).aux, params.aux, RecAuxCount(rd));
    bool success_rec_aux_state_post = RecAuxStateEqual(Rec(rec).aux, RecAuxCount(rd), REC_AUX);
    bool success_ripas_addr_post = Rec(rec).ripas_addr == Zeros();
    bool success_ripas_top_post = Rec(rec).ripas_top == Zeros();
    bool success_host_call_post = Rec(rec).host_call_pending == NO_HOST_CALL_PENDING;

    // Failure condition assertions
    bool prop_failure_params_align_ante = failure_params_align_pre;
    __COVER(prop_failure_params_align_ante);
    if (prop_failure_params_align_ante) {
        bool prop_failure_params_align_cons = failure_params_align_post;
        __COVER(prop_failure_params_align_cons);
        __ASSERT(prop_failure_params_align_cons, "prop_failure_params_align_cons");
    }

    bool prop_failure_params_bound_ante = !failure_params_align_pre
        && failure_params_bound_pre;
    __COVER(prop_failure_params_bound_ante);
    if (prop_failure_params_bound_ante) {
        bool prop_failure_params_bound_cons = failure_params_bound_post;
        __COVER(prop_failure_params_bound_cons);
        __ASSERT(prop_failure_params_bound_cons, "prop_failure_params_bound_cons");
    }

    bool prop_failure_params_pas_ante = !failure_params_align_pre
        && !failure_params_bound_pre
        && failure_params_pas_pre;
    __COVER(prop_failure_params_pas_ante);
    if (prop_failure_params_pas_ante) {
        bool prop_failure_params_pas_cons = failure_params_pas_post;
        __COVER(prop_failure_params_pas_cons);
        __ASSERT(prop_failure_params_pas_cons, "prop_failure_params_pas_cons");
    }

    bool prop_failure_rec_align_ante = !failure_params_align_pre
        && !failure_params_bound_pre
        && !failure_params_pas_pre
        && failure_rec_align_pre;
    __COVER(prop_failure_rec_align_ante);
    if (prop_failure_rec_align_ante) {
        bool prop_failure_rec_align_cons = failure_rec_align_post;
        __COVER(prop_failure_rec_align_cons);
        __ASSERT(prop_failure_rec_align_cons, "prop_failure_rec_align_cons");
    }

    bool prop_failure_rec_bound_ante = !failure_params_align_pre
        && !failure_params_bound_pre
        && !failure_params_pas_pre
        && !failure_rec_align_pre
        && failure_rec_bound_pre;
    __COVER(prop_failure_rec_bound_ante);
    if (prop_failure_rec_bound_ante) {
        bool prop_failure_rec_bound_cons = failure_rec_bound_post;
        __COVER(prop_failure_rec_bound_cons);
        __ASSERT(prop_failure_rec_bound_cons, "prop_failure_rec_bound_cons");
    }

    bool prop_failure_rec_state_ante = !failure_params_align_pre
        && !failure_params_bound_pre
        && !failure_params_pas_pre
        && !failure_rec_align_pre
        && !failure_rec_bound_pre
        && failure_rec_state_pre;
    __COVER(prop_failure_rec_state_ante);
    if (prop_failure_rec_state_ante) {
        bool prop_failure_rec_state_cons = failure_rec_state_post;
        __COVER(prop_failure_rec_state_cons);
        __ASSERT(prop_failure_rec_state_cons, "prop_failure_rec_state_cons");
    }

    bool prop_failure_rd_align_ante = !failure_params_align_pre
        && !failure_params_bound_pre
        && !failure_params_pas_pre
        && !failure_rec_align_pre
        && !failure_rec_bound_pre
        && !failure_rec_state_pre
        && failure_rd_align_pre;
    __COVER(prop_failure_rd_align_ante);
    if (prop_failure_rd_align_ante) {
        bool prop_failure_rd_align_cons = failure_rd_align_post;
        __COVER(prop_failure_rd_align_cons);
        __ASSERT(prop_failure_rd_align_cons, "prop_failure_rd_align_cons");
    }

    bool prop_failure_rd_bound_ante = !failure_params_align_pre
        && !failure_params_bound_pre
        && !failure_params_pas_pre
        && !failure_rec_align_pre
        && !failure_rec_bound_pre
        && !failure_rec_state_pre
        && !failure_rd_align_pre
        && failure_rd_bound_pre;
    __COVER(prop_failure_rd_bound_ante);
    if (prop_failure_rd_bound_ante) {
        bool prop_failure_rd_bound_cons = failure_rd_bound_post;
        __COVER(prop_failure_rd_bound_cons);
        __ASSERT(prop_failure_rd_bound_cons, "prop_failure_rd_bound_cons");
    }

    bool prop_failure_rd_state_ante = !failure_params_align_pre
        && !failure_params_bound_pre
        && !failure_params_pas_pre
        && !failure_rec_align_pre
        && !failure_rec_bound_pre
        && !failure_rec_state_pre
        && !failure_rd_align_pre
        && !failure_rd_bound_pre
        && failure_rd_state_pre;
    __COVER(prop_failure_rd_state_ante);
    if (prop_failure_rd_state_ante) {
        bool prop_failure_rd_state_cons = failure_rd_state_post;
        __COVER(prop_failure_rd_state_cons);
        __ASSERT(prop_failure_rd_state_cons, "prop_failure_rd_state_cons");
    }

    bool prop_failure_realm_state_ante = !failure_params_align_pre
        && !failure_params_bound_pre
        && !failure_params_pas_pre
        && !failure_rec_align_pre
        && !failure_rec_bound_pre
        && !failure_rec_state_pre
        && !failure_rd_align_pre
        && !failure_rd_bound_pre
        && !failure_rd_state_pre
        && failure_realm_state_pre;
    __COVER(prop_failure_realm_state_ante);
    if (prop_failure_realm_state_ante) {
        bool prop_failure_realm_state_cons = failure_realm_state_post;
        __COVER(prop_failure_realm_state_cons);
        __ASSERT(prop_failure_realm_state_cons, "prop_failure_realm_state_cons");
    }

    bool prop_failure_mpidr_index_ante = !failure_params_align_pre
        && !failure_params_bound_pre
        && !failure_params_pas_pre
        && !failure_rec_align_pre
        && !failure_rec_bound_pre
        && !failure_rec_state_pre
        && !failure_rd_align_pre
        && !failure_rd_bound_pre
        && !failure_rd_state_pre
        && !failure_realm_state_pre
        && failure_mpidr_index_pre;
    __COVER(prop_failure_mpidr_index_ante);
    if (prop_failure_mpidr_index_ante) {
        bool prop_failure_mpidr_index_cons = failure_mpidr_index_post;
        __COVER(prop_failure_mpidr_index_cons);
        __ASSERT(prop_failure_mpidr_index_cons, "prop_failure_mpidr_index_cons");
    }

    bool prop_failure_num_aux_ante = !failure_params_align_pre
        && !failure_params_bound_pre
        && !failure_params_pas_pre
        && !failure_rec_align_pre
        && !failure_rec_bound_pre
        && !failure_rec_state_pre
        && !failure_rd_align_pre
        && !failure_rd_bound_pre
        && !failure_rd_state_pre
        && !failure_realm_state_pre
        && !failure_mpidr_index_pre
        && failure_num_aux_pre;
    __COVER(prop_failure_num_aux_ante);
    if (prop_failure_num_aux_ante) {
        bool prop_failure_num_aux_cons = failure_num_aux_post;
        __COVER(prop_failure_num_aux_cons);
        __ASSERT(prop_failure_num_aux_cons, "prop_failure_num_aux_cons");
    }

    bool prop_failure_aux_align_ante = !failure_params_align_pre
        && !failure_params_bound_pre
        && !failure_params_pas_pre
        && !failure_rec_align_pre
        && !failure_rec_bound_pre
        && !failure_rec_state_pre
        && !failure_rd_align_pre
        && !failure_rd_bound_pre
        && !failure_rd_state_pre
        && !failure_realm_state_pre
        && !failure_mpidr_index_pre
        && !failure_num_aux_pre
        && failure_aux_align_pre;
    __COVER(prop_failure_aux_align_ante);
    if (prop_failure_aux_align_ante) {
        bool prop_failure_aux_align_cons = failure_aux_align_post;
        __COVER(prop_failure_aux_align_cons);
        __ASSERT(prop_failure_aux_align_cons, "prop_failure_aux_align_cons");
    }

    bool prop_failure_aux_alias_ante = !failure_params_align_pre
        && !failure_params_bound_pre
        && !failure_params_pas_pre
        && !failure_rec_align_pre
        && !failure_rec_bound_pre
        && !failure_rec_state_pre
        && !failure_rd_align_pre
        && !failure_rd_bound_pre
        && !failure_rd_state_pre
        && !failure_realm_state_pre
        && !failure_mpidr_index_pre
        && !failure_num_aux_pre
        && !failure_aux_align_pre
        && failure_aux_alias_pre;
    __COVER(prop_failure_aux_alias_ante);
    if (prop_failure_aux_alias_ante) {
        bool prop_failure_aux_alias_cons = failure_aux_alias_post;
        __COVER(prop_failure_aux_alias_cons);
        __ASSERT(prop_failure_aux_alias_cons, "prop_failure_aux_alias_cons");
    }

    bool prop_failure_aux_state_ante = !failure_params_align_pre
        && !failure_params_bound_pre
        && !failure_params_pas_pre
        && !failure_rec_align_pre
        && !failure_rec_bound_pre
        && !failure_rec_state_pre
        && !failure_rd_align_pre
        && !failure_rd_bound_pre
        && !failure_rd_state_pre
        && !failure_realm_state_pre
        && !failure_mpidr_index_pre
        && !failure_num_aux_pre
        && !failure_aux_align_pre
        && !failure_aux_alias_pre
        && failure_aux_state_pre;
    __COVER(prop_failure_aux_state_ante);
    if (prop_failure_aux_state_ante) {
        bool prop_failure_aux_state_cons = failure_aux_state_post;
        __COVER(prop_failure_aux_state_cons);
        __ASSERT(prop_failure_aux_state_cons, "prop_failure_aux_state_cons");
    }

    // Result assertion
    bool prop_result_ante = no_failures_pre;
    __COVER(prop_result_ante);
    if (prop_result_ante) {
        bool prop_result_cons = result == RMI_SUCCESS;
        __COVER(prop_result_cons);
        __ASSERT(prop_result_cons, "prop_result_cons");
    }

    // Success condition assertions
    bool prop_success_rec_index_ante = no_failures_pre;
    __COVER(prop_success_rec_index_ante);
    if (prop_success_rec_index_ante) {
        bool prop_success_rec_index_cons = success_rec_index_post;
        __COVER(prop_success_rec_index_cons);
        __ASSERT(prop_success_rec_index_cons, "prop_success_rec_index_cons");
    }

    bool prop_success_rec_gran_state_ante = no_failures_pre;
    __COVER(prop_success_rec_gran_state_ante);
    if (prop_success_rec_gran_state_ante) {
        bool prop_success_rec_gran_state_cons = success_rec_gran_state_post;
        __COVER(prop_success_rec_gran_state_cons);
        __ASSERT(prop_success_rec_gran_state_cons, "prop_success_rec_gran_state_cons");
    }

    bool prop_success_rec_owner_ante = no_failures_pre;
    __COVER(prop_success_rec_owner_ante);
    if (prop_success_rec_owner_ante) {
        bool prop_success_rec_owner_cons = success_rec_owner_post;
        __COVER(prop_success_rec_owner_cons);
        __ASSERT(prop_success_rec_owner_cons, "prop_success_rec_owner_cons");
    }

    bool prop_success_rec_attest_ante = no_failures_pre;
    __COVER(prop_success_rec_attest_ante);
    if (prop_success_rec_attest_ante) {
        bool prop_success_rec_attest_cons = success_rec_attest_post;
        __COVER(prop_success_rec_attest_cons);
        __ASSERT(prop_success_rec_attest_cons, "prop_success_rec_attest_cons");
    }

    bool prop_success_rec_mpidr_ante = no_failures_pre;
    __COVER(prop_success_rec_mpidr_ante);
    if (prop_success_rec_mpidr_ante) {
        bool prop_success_rec_mpidr_cons = success_rec_mpidr_post;
        __COVER(prop_success_rec_mpidr_cons);
        __ASSERT(prop_success_rec_mpidr_cons, "prop_success_rec_mpidr_cons");
    }

    bool prop_success_rec_state_ante = no_failures_pre;
    __COVER(prop_success_rec_state_ante);
    if (prop_success_rec_state_ante) {
        bool prop_success_rec_state_cons = success_rec_state_post;
        __COVER(prop_success_rec_state_cons);
        __ASSERT(prop_success_rec_state_cons, "prop_success_rec_state_cons");
    }

    bool prop_success_runnable_ante = no_failures_pre
        && success_runnable_pre;
    __COVER(prop_success_runnable_ante);
    if (prop_success_runnable_ante) {
        bool prop_success_runnable_cons = success_runnable_post;
        __COVER(prop_success_runnable_cons);
        __ASSERT(prop_success_runnable_cons, "prop_success_runnable_cons");
    }

    bool prop_success_not_runnable_ante = no_failures_pre
        && success_not_runnable_pre;
    __COVER(prop_success_not_runnable_ante);
    if (prop_success_not_runnable_ante) {
        bool prop_success_not_runnable_cons = success_not_runnable_post;
        __COVER(prop_success_not_runnable_cons);
        __ASSERT(prop_success_not_runnable_cons, "prop_success_not_runnable_cons");
    }

    bool prop_success_rec_gprs_ante = no_failures_pre;
    __COVER(prop_success_rec_gprs_ante);
    if (prop_success_rec_gprs_ante) {
        bool prop_success_rec_gprs_cons = success_rec_gprs_post;
        __COVER(prop_success_rec_gprs_cons);
        __ASSERT(prop_success_rec_gprs_cons, "prop_success_rec_gprs_cons");
    }

    bool prop_success_rec_pc_ante = no_failures_pre;
    __COVER(prop_success_rec_pc_ante);
    if (prop_success_rec_pc_ante) {
        bool prop_success_rec_pc_cons = success_rec_pc_post;
        __COVER(prop_success_rec_pc_cons);
        __ASSERT(prop_success_rec_pc_cons, "prop_success_rec_pc_cons");
    }

    bool prop_success_rim_ante = no_failures_pre;
    __COVER(prop_success_rim_ante);
    if (prop_success_rim_ante) {
        bool prop_success_rim_cons = success_rim_post;
        __COVER(prop_success_rim_cons);
        __ASSERT(prop_success_rim_cons, "prop_success_rim_cons");
    }

    bool prop_success_rec_aux_ante = no_failures_pre;
    __COVER(prop_success_rec_aux_ante);
    if (prop_success_rec_aux_ante) {
        bool prop_success_rec_aux_cons = success_rec_aux_post;
        __COVER(prop_success_rec_aux_cons);
        __ASSERT(prop_success_rec_aux_cons, "prop_success_rec_aux_cons");
    }

    bool prop_success_rec_aux_state_ante = no_failures_pre;
    __COVER(prop_success_rec_aux_state_ante);
    if (prop_success_rec_aux_state_ante) {
        bool prop_success_rec_aux_state_cons = success_rec_aux_state_post;
        __COVER(prop_success_rec_aux_state_cons);
        __ASSERT(prop_success_rec_aux_state_cons, "prop_success_rec_aux_state_cons");
    }

    bool prop_success_ripas_addr_ante = no_failures_pre;
    __COVER(prop_success_ripas_addr_ante);
    if (prop_success_ripas_addr_ante) {
        bool prop_success_ripas_addr_cons = success_ripas_addr_post;
        __COVER(prop_success_ripas_addr_cons);
        __ASSERT(prop_success_ripas_addr_cons, "prop_success_ripas_addr_cons");
    }

    bool prop_success_ripas_top_ante = no_failures_pre;
    __COVER(prop_success_ripas_top_ante);
    if (prop_success_ripas_top_ante) {
        bool prop_success_ripas_top_cons = success_ripas_top_post;
        __COVER(prop_success_ripas_top_cons);
        __ASSERT(prop_success_ripas_top_cons, "prop_success_ripas_top_cons");
    }

    bool prop_success_host_call_ante = no_failures_pre;
    __COVER(prop_success_host_call_ante);
    if (prop_success_host_call_ante) {
        bool prop_success_host_call_cons = success_host_call_post;
        __COVER(prop_success_host_call_cons);
        __ASSERT(prop_success_host_call_cons, "prop_success_host_call_cons");
    }

    // Assertion used to check consistency of the testbench
    __tb_expect_fail();

    return no_failures_pre;
}

