#
# SPDX-License-Identifier: BSD-3-Clause
# SPDX-FileCopyrightText: Copyright TF-RMM Contributors.
#

%YAML 1.2
---
description: >-
  Overlay to build and run TF-A and TFTF. By default this Overlay pulls
  ``master`` branch for all the repositories involved.

layers:
  - tftf-base.yaml
  - tfa-base.yaml
  - FVP_Base_RevC-2xAEMvA-base.yaml

buildex:
  btvars:
    # Determines the branch or SHA to pull for TF-A
    TFA_REVISION:
      type: string
      value: master

    # Determines the branch or SHA to pull for TFTF
    TFTF_REVISION:
      type: string
      value: master

build:
  tftf:
    repo:
      revision: ${btvar:TFTF_REVISION}
    artifacts:
      TFTF_BIN: ${param:builddir}/fvp/release/tftf.bin

  tfa:
    repo:
      revision: ${btvar:TFA_REVISION}
    params:
      CTX_INCLUDE_PAUTH_REGS: 1
      ENABLE_SVE_FOR_NS: 2
      ENABLE_SVE_FOR_SWD: 1
      RMM: ${artifact:RMM}
      BL33: ${artifact:TFTF_BIN}

run:
  rtvars:
    BL1:
      type: path
      value: ${artifact:BL1}

    FIP:
      type: path
      value: ${artifact:FIP}

  params:
    # Suppress "WARNING: MPAM_NS is deprecated when RME is in use. Should use MPAM_SP"
    -C cluster0.output_attributes: ExtendedID[62:55]=MPAM_PMG,ExtendedID[54:39]=MPAM_PARTID,ExtendedID[38:37]=MPAM_SP
    -C cluster1.output_attributes: ExtendedID[62:55]=MPAM_PMG,ExtendedID[54:39]=MPAM_PARTID,ExtendedID[38:37]=MPAM_SP

    # CCA-specific SMMU settings.
    -C pci.pci_smmuv3.mmu.SMMU_ROOT_IDR0: 3
    -C pci.pci_smmuv3.mmu.SMMU_ROOT_IIDR: 0x43B
    -C pci.pci_smmuv3.mmu.root_register_page_offset: 0x20000

    # Enable FEAT_CSV2_2, which is optional. But TFA 2.10 force-enables it when
    # ENABLE_RME=1 so if it's not there we see an exception.
    -C cluster0.restriction_on_speculative_execution: 2
    -C cluster1.restriction_on_speculative_execution: 2
    -C cluster0.restriction_on_speculative_execution_aarch32: 2
    -C cluster1.restriction_on_speculative_execution_aarch32: 2
    -C cluster0.cpu0.RVBAR: 0
    -C cluster0.cpu1.RVBAR: 0
    -C cluster0.cpu2.RVBAR: 0
    -C cluster0.cpu3.RVBAR: 0
    -C cluster1.cpu0.RVBAR: 0
    -C cluster1.cpu1.RVBAR: 0
    -C cluster1.cpu2.RVBAR: 0
    -C cluster1.cpu3.RVBAR: 0

    -C bp.secureflashloader.fname: ${rtvar:BL1}
    -C bp.flashloader0.fname: ${rtvar:FIP}
